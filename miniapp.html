<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js"><!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Développement web côté serveur avec PHP</title>
<meta name="description" content="">

<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0" />

<link href="css/vendor/normalize.css" rel="stylesheet" type="text/css" />
<link href="css/vendor/foundation.css" rel="stylesheet" type="text/css" />
<link href="css/vendor/pygmentize.css" rel="stylesheet" type="text/css" />
<!-- <link href="css/vendor/syntax.css" rel="stylesheet" type="text/css" /> -->
<link href="css/style.css" rel="stylesheet" type="text/css" />

<script src="js/vendor/modernizr.js"></script>

</head>
<body>
<!--[if lt IE 7]>
<p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->

<section class="row">
    <article class="columns small-12">

        <h1><a href="index.html">Développement web côté serveur avec PHP</a></h1>


<h2 id="exemple-dune-mini-application">exemple d’une mini application</h2>

<h3 id="les-pages">les pages</h3>

<p>Cette mini application contient les pages suivantes :</p>

<ul>
  <li>une page de connexion</li>
  <li>une page d’inscription</li>
  <li>une page qui permet de se faire envoyer un nouveau mot de passe par mail</li>
  <li>une home page sécurisée</li>
  <li>une page permettant de mofidier ses informationjs personnelles</li>
  <li>une page permettant de se déconnecter</li>
  <li>une page d’erreur que l’on peut afficher lorsqu’un problème technique se présente</li>
</ul>

<p>Cette mini application possède les particularités suivantes :</p>

<ul>
  <li>l’utilisation d’un fichier unique de connexion à la base de données</li>
  <li>l’accès aux pages sécurisées sans s’être connecté renvoit vers la page de connexion</li>
  <li>certaines fonctionnalités sont isolées dans des fichiers de librairie afin de faciliter la réutilisation dans ce projet et dans d’autres projets</li>
  <li>les best practices de la sécurité sont respectées :
    <ul>
      <li>stockage des mots de passe sous forme de hash</li>
      <li>échappement des variables avant utilisation dans du code sql</li>
      <li>échappement des variables avant utilisation dans du code html</li>
    </ul>
  </li>
  <li>toutes les erreurs renvoient vers une page d’erreur dédiée</li>
</ul>

<h3 id="lorganisation-des-fichiers">l’organisation des fichiers</h3>

<ul>
  <li>le dossier <code class="highlighter-rouge">data</code> contient le fichier de la base de données</li>
  <li>le dossier <code class="highlighter-rouge">lib</code> contient les fichiers des librairies</li>
  <li>le dossier <code class="highlighter-rouge">web</code> contient les fichiers des pages de l’application</li>
</ul>

<h3 id="le-fichier-de-la-base-de-donnes">le fichier de la base de données</h3>

<p><strong>Note</strong> : n’hésitez pas à changer le nom de la base de données. Pensez juste à répercuter la modification dans le fichier de connexion.</p>

<p><a href="code/miniapp/data/bdd-test.sql">code/miniapp/data/bdd-test.sql</a></p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">test</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">test</span> <span class="k">DEFAULT</span> <span class="n">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span><span class="p">;</span>
<span class="n">USE</span> <span class="n">test</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="k">user</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="k">user</span> <span class="p">(</span>
  <span class="n">id</span> <span class="n">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="n">nom</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">prenom</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">email</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">password_hash</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1</span> <span class="p">;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="le-fichier-de-connexion--la-base-de-donnes">le fichier de connexion à la base de données</h3>

<p><strong>Attention</strong> : vous devez adpater ce script avec les réglages de votre base de données (serveur, login, mot de passe, nom de la base de données).</p>

<p><a href="code/miniapp/web/mysqli-connect.php">code/miniapp/web/mysqli-connect.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// @warning changez les codes d'accès pour les adapter à votre configuration
</span>
<span class="c1">// connexion au serveur mysql
</span><span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysqli_connect</span><span class="p">(</span><span class="s1">'server'</span><span class="p">,</span> <span class="s1">'login'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">,</span> <span class="s1">'database'</span><span class="p">);</span>

<span class="c1">// vérification de la connexion
</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$link</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// @dev pendant le développement, on peut afficher l'erreur de connexion
</span>    <span class="c1">// echo 'erreur de connexion à la base de données mysql : ' . mysqli_connect_error();
</span>    <span class="c1">// exit();
</span>
    <span class="c1">// @prod quand le site est en production, on redirige l'utilisateur vers une page d'erreur
</span>    <span class="nb">header</span><span class="p">(</span><span class="s1">'location: erreur-500.php'</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">mysqli_set_charset</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="s1">'utf8'</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="les-fichiers-des-pages">les fichiers des pages</h3>

<p><a href="code/miniapp/web/connexion.php">code/miniapp/web/connexion.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des librairies
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/security.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/session.php'</span><span class="p">);</span>

<span class="c1">// démarrage de la session
</span><span class="nx">session_safe_start</span><span class="p">();</span>

<span class="c1">// vérification si l'utilisateur n'est pas déjà connecté
</span><span class="k">if</span> <span class="p">(</span><span class="nx">security_user_is_set</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// redirection de l'utilisateur vers la home page
</span>    <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'home.php'</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// connexion à la base de données
</span><span class="k">require</span><span class="p">(</span><span class="s1">'mysqli-connect.php'</span><span class="p">);</span>

<span class="nv">$validation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné d'email"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné de mot de passe"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// on ne traite le formulaire que si l'utilisateur a envoyé des données et qu'elles sont valides
</span><span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="o">&amp;&amp;</span> <span class="nv">$validation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// création de la requête sql
</span>    <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
        <span class="s2">"SELECT * FROM user WHERE email = '%s'"</span><span class="p">,</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$email</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="c1">// exécution de la requête sql
</span>    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>

    <span class="c1">// vérification du résultat de la requête
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// récupération de la première ligne de résultat
</span>        <span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysqli_fetch_assoc</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

        <span class="c1">// vérification de la première ligne de résultat
</span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">password_verify</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'password_hash'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="c1">// stockage de l'identité de l'utilisateur dans la variable de session
</span>                <span class="nx">security_set_user</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span>
                    <span class="s1">'prenom'</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">],</span>
                    <span class="s1">'nom'</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">],</span>
                    <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
                <span class="p">));</span>

                <span class="c1">// redirection de l'utilisateur vers la home page
</span>                <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'home.php'</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// email correct mais mot de passe incorrect
</span>                <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'votre email ou votre mot de passe est inccorect'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// email incorrect
</span>            <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'votre email ou votre mot de passe est inccorect'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// @debug
</span>        <span class="c1">// echo "erreur d'exécution de la requête sql : " . mysqli_error($link);
</span>        <span class="c1">// exit();
</span>
        <span class="c1">// redirection vers une page d'erreur
</span>        <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'erreur-500.php'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messages</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$messages</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"email"</span><span class="nt">&gt;</span>email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>mot de passe<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"se connecter"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"inscription.php"</span><span class="nt">&gt;</span>inscription<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"mot-de-passe-oublie.php"</span><span class="nt">&gt;</span>mot de passe oublié<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/deconnexion.php">code/miniapp/web/deconnexion.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des librairies
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/security.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/session.php'</span><span class="p">);</span>

<span class="c1">// démarrage de la session
</span><span class="nx">session_safe_start</span><span class="p">();</span>

<span class="c1">// sécurisation de la page
</span><span class="nx">security_filter_user</span><span class="p">();</span>

<span class="c1">// destruction des données liées à l'utilisateur en cours
</span><span class="nx">security_destroy_user</span><span class="p">();</span>

<span class="c1">// destruction de la session en cours
</span><span class="nb">session_destroy</span><span class="p">();</span>

<span class="c1">// redirection de l'utilisateur vers la page de login
</span><span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'connexion.php'</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/erreur-500.php">code/miniapp/web/erreur-500.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s1">'HTTP/1.1 500 Internal Server Error'</span><span class="p">);</span>
<span class="cp">?&gt;&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

    <span class="nt">&lt;h1&gt;</span>Oups, problème technique :(<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;p&gt;</span>Nous sommes désolés, un problème technique est survenu. Nous mettons tout en œuvre pour le régler rapidement. Revenez nous voir ultérieurement.<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/home.php">code/miniapp/web/home.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des librairies
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/security.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/session.php'</span><span class="p">);</span>

<span class="c1">// démarrage de la session
</span><span class="nx">session_safe_start</span><span class="p">();</span>

<span class="c1">// sécurisation de la page
</span><span class="nx">security_filter_user</span><span class="p">();</span>

<span class="cp">?&gt;&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;h1&gt;</span>home<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div&gt;</span>
    Bonjour <span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'prenom'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">' '</span> <span class="o">.</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'nom'</span><span class="p">]);</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"profil.php"</span><span class="nt">&gt;</span>profil<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"deconnexion.php"</span><span class="nt">&gt;</span>déconnexion<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/index.php">code/miniapp/web/index.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des librairies
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>

<span class="c1">// redirection de l'utilisateur vers la page de login
</span><span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'connexion.php'</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/inscription.php">code/miniapp/web/inscription.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des librairies
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/security.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/session.php'</span><span class="p">);</span>

<span class="c1">// démarrage de la session
</span><span class="nx">session_safe_start</span><span class="p">();</span>

<span class="c1">// connexion à la base de données
</span><span class="k">require</span><span class="p">(</span><span class="s1">'mysqli-connect.php'</span><span class="p">);</span>

<span class="nv">$validation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$prenom</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$nom</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$password_confirmation</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$prenom</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné de prénom"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$nom</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné de nom"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné d'email"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné de mot de passe"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password_confirmation'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password_confirmation'</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="p">{</span>
        <span class="nv">$password_confirmation</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password_confirmation'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"la confirmation de votre mot de passe ne correspond pas"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// on ne traite le formulaire que si l'utilisateur a envoyé des données et qu'elles sont valides
</span><span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="o">&amp;&amp;</span> <span class="nv">$validation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// vérification si cet email n'est pas déjà enregistré
</span>    <span class="c1">// création de la requête sql
</span>    <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
        <span class="s2">"SELECT * FROM user WHERE email = '%s'"</span><span class="p">,</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$email</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="c1">// exécution de la requête sql
</span>    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>

    <span class="c1">// vérification du résultat de la requête
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="na">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// cet email est déjà enregistré, l'utilisateur ne peut pas créer de compte
</span>        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"désolé, cet email est déjà utilisé"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// cet email n'est pas encore enregistré, l'utilisateur peut créer un compte
</span>
        <span class="c1">// paramètres de la requêtes sql
</span>        <span class="nv">$password_hash</span> <span class="o">=</span> <span class="nb">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_BCRYPT</span><span class="p">);</span>

        <span class="c1">// création de la requête sql
</span>        <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
            <span class="s2">"INSERT INTO user
            (prenom, nom, email, password_hash)
            VALUES
            ('%s', '%s', '%s', '%s')"</span><span class="p">,</span>
            <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$prenom</span><span class="p">),</span>
            <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$nom</span><span class="p">),</span>
            <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$email</span><span class="p">),</span>
            <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$password_hash</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="c1">// exécution de la requête sql
</span>        <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>

        <span class="c1">// vérification du résultat de la requête
</span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// stockage de l'identité de l'utilisateur dans la variable de session
</span>            <span class="nx">security_set_user</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nx">mysqli_insert_id</span><span class="p">(</span><span class="nv">$link</span><span class="p">),</span>
                <span class="s1">'prenom'</span> <span class="o">=&gt;</span> <span class="nv">$prenom</span><span class="p">,</span>
                <span class="s1">'nom'</span> <span class="o">=&gt;</span> <span class="nv">$nom</span><span class="p">,</span>
                <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span>
            <span class="p">));</span>

            <span class="c1">// redirection de l'utilisateur vers la home page
</span>            <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'home.php'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// @debug
</span>            <span class="c1">// echo "erreur d'exécution de la requête sql : " . mysqli_error($link);
</span>            <span class="c1">// exit();
</span>
            <span class="c1">// redirection vers une page d'erreur
</span>            <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'erreur-500.php'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messages</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$messages</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span><span class="nt">&gt;</span>prenom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$prenom</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"nom"</span><span class="nt">&gt;</span>nom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"nom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$nom</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"email"</span><span class="nt">&gt;</span>email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>mot de passe<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password_confirmation"</span><span class="nt">&gt;</span>confirmation du mot de passe<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password_confirmation"</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$password_confirmation</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"s'inscrire"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"connexion.php"</span><span class="nt">&gt;</span>connexion<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"mot-de-passe-oublie.php"</span><span class="nt">&gt;</span>mot de passe oublié<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/mot-de-passe-oublie.php">code/miniapp/web/mot-de-passe-oublie.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des librairies
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/password.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/session.php'</span><span class="p">);</span>

<span class="c1">// démarrage de la session
</span><span class="nx">session_safe_start</span><span class="p">();</span>

<span class="c1">// connexion à la base de données
</span><span class="k">require</span><span class="p">(</span><span class="s1">'mysqli-connect.php'</span><span class="p">);</span>

<span class="nv">$validation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$password</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné d'email"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// on ne traite le formulaire que si l'utilisateur a envoyé des données et qu'elles sont valides
</span><span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="o">&amp;&amp;</span> <span class="nv">$validation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// création de la requête sql
</span>    <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
        <span class="s2">"SELECT * FROM user WHERE email = '%s'"</span><span class="p">,</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$email</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="c1">// exécution de la requête sql
</span>    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>

    <span class="c1">// on ne traite la demande de création d'un nouveau mot de passe que si l'email existe
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="na">num_rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// création d'un nouveau mot de passe
</span>        <span class="nv">$password</span> <span class="o">=</span> <span class="nx">password_generate_random_string</span><span class="p">();</span>

        <span class="c1">// paramètres de la requêtes sql
</span>        <span class="nv">$password_hash</span> <span class="o">=</span> <span class="nb">password_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nx">PASSWORD_BCRYPT</span><span class="p">);</span>

        <span class="c1">// création de la requête sql
</span>        <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
            <span class="s2">"UPDATE user
            SET password_hash = '%s'
            WHERE email = '%s'"</span><span class="p">,</span>
            <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$password_hash</span><span class="p">),</span>
            <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$email</span><span class="p">)</span>
        <span class="p">);</span>

        <span class="c1">// exécution de la requête sql
</span>        <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>

        <span class="c1">// vérification du résultat de la requête
</span>        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$to</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
            <span class="nv">$subject</span> <span class="o">=</span> <span class="s1">'Nouveau mot de passe'</span><span class="p">;</span>
            <span class="nv">$text</span> <span class="o">=</span> <span class="s1">'votre nouveau mot de passe : '</span> <span class="o">.</span> <span class="nv">$password</span><span class="p">;</span>
            <span class="nv">$text</span> <span class="o">=</span> <span class="nb">wordwrap</span><span class="p">(</span><span class="nv">$text</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">);</span>

            <span class="c1">// @debug
</span>            <span class="c1">// echo $text . '&lt;br /&gt;';
</span>            <span class="c1">// exit();
</span>
            <span class="c1">// envoi du mail
</span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">mail</span><span class="p">(</span><span class="nv">$to</span><span class="p">,</span> <span class="nv">$subject</span><span class="p">,</span> <span class="nv">$text</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// redirection vers une page d'erreur si le mail n'a pas pu être envoyé
</span>                <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'erreur-500.php'</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// @debug
</span>            <span class="c1">// echo 'erreur d\'exécution de la requête sql : ' . mysqli_error($link);
</span>            <span class="c1">// exit();
</span>
            <span class="c1">// redirection vers une page d'erreur
</span>            <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'erreur-500.php'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'cet email est introuvable'</span><span class="p">;</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messages</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$messages</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"email"</span><span class="nt">&gt;</span>email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$email</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"obtenir un nouveau mot de passe"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"connexion.php"</span><span class="nt">&gt;</span>connexion<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"inscription.php"</span><span class="nt">&gt;</span>inscription<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/web/profil.php">code/miniapp/web/profil.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// inclusion des libraries
</span><span class="k">require</span><span class="p">(</span><span class="s1">'../lib/http.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/security.php'</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span><span class="s1">'../lib/session.php'</span><span class="p">);</span>

<span class="c1">// démarrage de la session
</span><span class="nx">session_safe_start</span><span class="p">();</span>

<span class="c1">// sécurisation de la page
</span><span class="nx">security_filter_user</span><span class="p">();</span>

<span class="c1">// connexion à la base de données
</span><span class="k">require</span><span class="p">(</span><span class="s1">'mysqli-connect.php'</span><span class="p">);</span>

<span class="nv">$validation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nv">$messages</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$prenom</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$nom</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$email</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$prenom</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'prenom'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné de prénom"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$nom</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné de nom"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'email'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$validation</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"vous n'avez pas renseigné d'email"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// on ne traite le formulaire que si l'utilisateur a envoyé des données et qu'elles sont valides
</span><span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span> <span class="o">&amp;&amp;</span> <span class="nv">$validation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// vérification si cet email n'est pas déjà enregistré
</span>    <span class="c1">// création de la requête sql
</span>    <span class="nv">$sql</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span>
        <span class="s2">"UPDATE user
        SET prenom = '%s', nom = '%s', email = '%s'
        WHERE id = %d"</span><span class="p">,</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$prenom</span><span class="p">),</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$nom</span><span class="p">),</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$email</span><span class="p">),</span>
        <span class="nx">mysqli_real_escape_string</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'id'</span><span class="p">])</span>
    <span class="p">);</span>

    <span class="c1">// exécution de la requête sql
</span>    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$sql</span><span class="p">);</span>

    <span class="c1">// vérification du résultat de la requête
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// stockage de l'identité de l'utilisateur dans la variable de session
</span>        <span class="nx">security_set_user</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'id'</span><span class="p">],</span>
            <span class="s1">'prenom'</span> <span class="o">=&gt;</span> <span class="nv">$prenom</span><span class="p">,</span>
            <span class="s1">'nom'</span> <span class="o">=&gt;</span> <span class="nv">$nom</span><span class="p">,</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$email</span>
        <span class="p">));</span>

        <span class="nv">$messages</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">"votre profil a été mis à jour"</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// @debug
</span>        <span class="c1">// echo "erreur d'exécution de la requête sql : " . mysqli_error($link);
</span>        <span class="c1">// exit();
</span>
        <span class="c1">// redirection vers une page d'erreur
</span>        <span class="nb">http_redirect</span><span class="p">(</span><span class="s1">'erreur-500.php'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;h1&gt;</span>profil<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$messages</span><span class="p">))</span><span class="o">:</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="cp">&lt;?php</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$messages</span> <span class="k">as</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$messages</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;br /&gt;'</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">endif</span><span class="p">;</span> <span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"id"</span> <span class="nt">&gt;</span>id<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">disabled=</span><span class="s">"disabled"</span> <span class="na">name=</span><span class="s">"id"</span>  <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'id'</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"nom"</span> <span class="nt">&gt;</span>nom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"nom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'nom'</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"prenom"</span> <span class="nt">&gt;</span>prenom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"prenom"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'prenom'</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"email"</span> <span class="nt">&gt;</span>email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'user'</span><span class="p">][</span><span class="s1">'email'</span><span class="p">]);</span> <span class="cp">?&gt;</span><span class="s">"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"mettre à jour"</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"home.php"</span><span class="nt">&gt;</span>home<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"deconnexion.php"</span><span class="nt">&gt;</span>déconnexion<span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="les-fichiers-des-librairies">les fichiers des librairies</h3>

<p><a href="code/miniapp/lib/http.php">code/miniapp/lib/http.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="sd">/**
 * redirect
 *
 * redirige vers une url
 *
 * @param string $url l'url vers laquelle rediriger
 * @return void
 */</span>
<span class="k">function</span> <span class="nf">http_redirect</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'location: '</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">302</span><span class="p">);</span>
    <span class="k">exit</span><span class="p">();</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/lib/password.php">code/miniapp/lib/password.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="sd">/**
 * password_generate_random_string
 *
 * source:
 *  Generating a random password in php - Stack Overflow
 *  http://stackoverflow.com/questions/6101956/generating-a-random-password-in-php#answer-6101969
 *
 * generates a random password
 *
 * @param int $password_length OPTIONAL desired length of the generated password, defaults to 12
 * @return string random password
 */</span>
<span class="k">function</span> <span class="nf">password_generate_random_string</span><span class="p">(</span><span class="nv">$password_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$symbols</span> <span class="o">=</span> <span class="s2">"abcdefghijklmnopqrstuwxyzABCDEFGHIJKLMNOPQRSTUWXYZ0123456789"</span><span class="p">;</span>
    <span class="nv">$password</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$symbols_count</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$symbols</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$password_length</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$n</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$symbols_count</span><span class="p">);</span>
        <span class="nv">$password</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$symbols</span><span class="p">[</span><span class="nv">$n</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">implode</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/lib/security.php">code/miniapp/lib/security.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">security_filter_user</span><span class="p">(</span><span class="nv">$key</span> <span class="o">=</span> <span class="s1">'user'</span><span class="p">,</span> <span class="nv">$url</span> <span class="o">=</span> <span class="s1">'connexion.php'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nb">http_redirect</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">security_destroy_user</span><span class="p">(</span><span class="nv">$key</span> <span class="o">=</span> <span class="s1">'user'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">unset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">security_set_user</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s1">'user'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">security_user_is_set</span><span class="p">(</span><span class="nv">$key</span> <span class="o">=</span> <span class="s1">'user'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><a href="code/miniapp/lib/session.php">code/miniapp/lib/session.php</a></p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">session_safe_start</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">session_id</span><span class="p">())</span> <span class="p">{</span>
        <span class="nb">session_start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>



    </article>
</section>

</body>
</html>

